<!doctype html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PulseChat AI | لوحة التحكم</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { cairo: ["Cairo", "sans-serif"] },
            colors: { primary: "#3B82F6", secondary: "#8B5CF6", accent: "#10B981", dark: "#0F172A", darker: "#020617", surface: "#1E293B" },
          },
        },
      };
    </script>
    <style>body { font-family: "Cairo", sans-serif; }</style>
</head>
<body class="bg-darker text-white min-h-screen">
    <!-- Top Nav -->
    <nav class="bg-dark/80 backdrop-blur-md border-b border-white/10 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-robot text-2xl text-primary"></i>
                <span class="text-xl font-bold">PulseChat <span class="text-primary">AI</span></span>
                <span class="bg-primary/20 text-primary text-xs px-3 py-1 rounded-full font-bold mr-2">Admin</span>
            </div>
            <div class="flex items-center gap-4">
                <a href="/" class="text-gray-400 hover:text-white text-sm transition-colors">
                    <i class="fas fa-globe ml-1"></i> الموقع
                </a>
                <button onclick="logout()" class="text-gray-400 hover:text-red-400 text-sm transition-colors">
                    <i class="fas fa-sign-out-alt ml-1"></i> خروج
                </button>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Stats Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-surface border border-white/10 rounded-xl p-5">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-gray-400 text-sm">إجمالي العملاء</span>
                    <i class="fas fa-users text-primary"></i>
                </div>
                <p class="text-3xl font-bold text-white">{{ stats.total }}</p>
            </div>
            <div class="bg-surface border border-white/10 rounded-xl p-5">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-gray-400 text-sm">عملاء اليوم</span>
                    <i class="fas fa-calendar-day text-accent"></i>
                </div>
                <p class="text-3xl font-bold text-accent">{{ stats.today }}</p>
            </div>
            <div class="bg-surface border border-white/10 rounded-xl p-5">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-gray-400 text-sm">نسبة التحويل</span>
                    <i class="fas fa-chart-line text-secondary"></i>
                </div>
                <p class="text-3xl font-bold text-secondary">{{ stats.conversion_rate }}%</p>
            </div>
            <div class="bg-surface border border-white/10 rounded-xl p-5">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-gray-400 text-sm">أعلى قطاع</span>
                    <i class="fas fa-trophy text-yellow-400"></i>
                </div>
                <p class="text-lg font-bold text-yellow-400">{{ sector_labels.get(stats.top_sector, stats.top_sector) }}</p>
            </div>
        </div>

        <!-- Status Summary -->
        <div class="grid grid-cols-4 gap-3 mb-8">
            <button onclick="filterByStatus('new')" class="bg-blue-500/10 border border-blue-500/20 rounded-lg p-3 text-center hover:bg-blue-500/20 transition-colors">
                <p class="text-2xl font-bold text-blue-400">{{ stats.new }}</p>
                <p class="text-xs text-gray-400">جديد</p>
            </button>
            <button onclick="filterByStatus('contacted')" class="bg-yellow-500/10 border border-yellow-500/20 rounded-lg p-3 text-center hover:bg-yellow-500/20 transition-colors">
                <p class="text-2xl font-bold text-yellow-400">{{ stats.contacted }}</p>
                <p class="text-xs text-gray-400">تم التواصل</p>
            </button>
            <button onclick="filterByStatus('converted')" class="bg-green-500/10 border border-green-500/20 rounded-lg p-3 text-center hover:bg-green-500/20 transition-colors">
                <p class="text-2xl font-bold text-green-400">{{ stats.converted }}</p>
                <p class="text-xs text-gray-400">تم التحويل</p>
            </button>
            <button onclick="filterByStatus('rejected')" class="bg-red-500/10 border border-red-500/20 rounded-lg p-3 text-center hover:bg-red-500/20 transition-colors">
                <p class="text-2xl font-bold text-red-400">{{ stats.rejected }}</p>
                <p class="text-xs text-gray-400">مرفوض</p>
            </button>
        </div>

        <!-- Filters & Actions -->
        <div class="flex flex-wrap items-center gap-3 mb-4">
            <div class="flex-1 min-w-[200px]">
                <input type="text" id="search-input" placeholder="بحث باسم الشركة أو الهاتف..."
                    class="w-full bg-surface border border-white/10 rounded-lg px-4 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-primary" />
            </div>
            <select id="sector-filter" onchange="filterBySector(this.value)"
                class="bg-surface border border-white/10 rounded-lg px-4 py-2 text-sm text-gray-300 focus:outline-none focus:border-primary">
                <option value="">كل القطاعات</option>
                {% for key, label in sector_labels.items() %}
                <option value="{{ key }}">{{ label }}</option>
                {% endfor %}
            </select>
            <button onclick="filterByStatus('')" class="bg-surface border border-white/10 rounded-lg px-4 py-2 text-sm text-gray-300 hover:bg-white/5 transition-colors">
                <i class="fas fa-redo ml-1"></i> إعادة تعيين
            </button>
            <a href="/api/admin/export" class="bg-accent/20 border border-accent/30 text-accent rounded-lg px-4 py-2 text-sm hover:bg-accent/30 transition-colors">
                <i class="fas fa-download ml-1"></i> تصدير CSV
            </a>
        </div>

        <!-- Leads Table -->
        <div class="bg-surface border border-white/10 rounded-xl overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-right" id="leads-table">
                    <thead class="bg-dark/50 text-gray-400 text-xs uppercase">
                        <tr>
                            <th class="px-4 py-3">#</th>
                            <th class="px-4 py-3">الشركة</th>
                            <th class="px-4 py-3">الهاتف</th>
                            <th class="px-4 py-3">القطاع</th>
                            <th class="px-4 py-3">الحالة</th>
                            <th class="px-4 py-3">التاريخ</th>
                            <th class="px-4 py-3">إجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="leads-tbody" class="divide-y divide-white/5">
                        {% for lead in leads %}
                        <tr class="hover:bg-white/5 transition-colors lead-row"
                            data-id="{{ lead.id }}"
                            data-status="{{ lead.status }}"
                            data-sector="{{ lead.sector }}">
                            <td class="px-4 py-3 text-gray-500 text-sm">{{ lead.id }}</td>
                            <td class="px-4 py-3 font-bold text-white">{{ lead.company_name }}</td>
                            <td class="px-4 py-3">
                                <a href="https://wa.me/{{ lead.phone }}" target="_blank"
                                    class="text-green-400 hover:text-green-300 transition-colors">
                                    <i class="fab fa-whatsapp ml-1"></i>{{ lead.phone }}
                                </a>
                            </td>
                            <td class="px-4 py-3 text-gray-400 text-sm">{{ sector_labels.get(lead.sector, lead.sector) }}</td>
                            <td class="px-4 py-3">
                                <select onchange="updateStatus({{ lead.id }}, this.value)"
                                    class="bg-dark/50 border border-white/10 rounded-lg px-2 py-1 text-xs focus:outline-none
                                    {% if lead.status == 'new' %}text-blue-400
                                    {% elif lead.status == 'contacted' %}text-yellow-400
                                    {% elif lead.status == 'converted' %}text-green-400
                                    {% elif lead.status == 'rejected' %}text-red-400
                                    {% endif %}">
                                    <option value="new" {% if lead.status == 'new' %}selected{% endif %}>جديد</option>
                                    <option value="contacted" {% if lead.status == 'contacted' %}selected{% endif %}>تم التواصل</option>
                                    <option value="converted" {% if lead.status == 'converted' %}selected{% endif %}>تم التحويل</option>
                                    <option value="rejected" {% if lead.status == 'rejected' %}selected{% endif %}>مرفوض</option>
                                </select>
                            </td>
                            <td class="px-4 py-3 text-gray-500 text-xs">
                                {{ lead.created_at.strftime('%Y-%m-%d %H:%M') if lead.created_at else '-' }}
                            </td>
                            <td class="px-4 py-3">
                                <div class="flex items-center gap-2">
                                    <button onclick="showNotes({{ lead.id }}, '{{ lead.notes|default('', true)|e }}')"
                                        class="text-gray-400 hover:text-primary transition-colors text-sm" title="ملاحظات">
                                        <i class="fas fa-sticky-note"></i>
                                    </button>
                                    <button onclick="deleteLead({{ lead.id }})"
                                        class="text-gray-400 hover:text-red-400 transition-colors text-sm" title="حذف">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}

                        {% if not leads %}
                        <tr>
                            <td colspan="7" class="px-4 py-12 text-center text-gray-500">
                                <i class="fas fa-inbox text-4xl mb-3 block"></i>
                                لا يوجد عملاء بعد
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        <p class="text-center text-gray-600 text-xs mt-8">&copy; 2026 PulseChat AI - لوحة التحكم</p>
    </div>

    <!-- Notes Modal -->
    <div id="notes-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center">
        <div class="bg-surface border border-white/10 rounded-2xl p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-bold text-white mb-4">
                <i class="fas fa-sticky-note text-primary ml-2"></i> ملاحظات
            </h3>
            <textarea id="notes-text" rows="4"
                class="w-full bg-dark/50 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:border-primary text-right resize-none"
                placeholder="أضف ملاحظاتك هنا..."></textarea>
            <div class="flex gap-3 mt-4">
                <button onclick="saveNotes()" class="flex-1 bg-primary hover:bg-blue-600 text-white font-bold py-2 rounded-xl transition-all">حفظ</button>
                <button onclick="closeNotes()" class="flex-1 bg-dark border border-white/10 text-gray-300 font-bold py-2 rounded-xl transition-all hover:bg-white/5">إلغاء</button>
            </div>
        </div>
    </div>

    <script>
        let currentLeadId = null;

        // Update lead status
        async function updateStatus(id, status) {
            try {
                const res = await fetch(`/api/admin/leads/${id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status }),
                });
                if (res.ok) {
                    location.reload();
                } else if (res.status === 401) {
                    window.location.href = '/admin/login';
                }
            } catch (err) {
                alert('حدث خطأ');
            }
        }

        // Delete lead
        async function deleteLead(id) {
            if (!confirm('هل أنت متأكد من حذف هذا العميل؟')) return;
            try {
                const res = await fetch(`/api/admin/leads/${id}`, {
                    method: 'DELETE',
                });
                if (res.ok) {
                    location.reload();
                } else if (res.status === 401) {
                    window.location.href = '/admin/login';
                }
            } catch (err) {
                alert('حدث خطأ');
            }
        }

        // Notes modal
        function showNotes(id, notes) {
            currentLeadId = id;
            document.getElementById('notes-text').value = notes;
            document.getElementById('notes-modal').classList.remove('hidden');
        }

        function closeNotes() {
            document.getElementById('notes-modal').classList.add('hidden');
            currentLeadId = null;
        }

        async function saveNotes() {
            if (!currentLeadId) return;
            const notes = document.getElementById('notes-text').value;
            try {
                const res = await fetch(`/api/admin/leads/${currentLeadId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ notes }),
                });
                if (res.ok) {
                    closeNotes();
                    location.reload();
                } else if (res.status === 401) {
                    window.location.href = '/admin/login';
                }
            } catch (err) {
                alert('حدث خطأ');
            }
        }

        // Filter by status
        function filterByStatus(status) {
            const rows = document.querySelectorAll('.lead-row');
            rows.forEach(row => {
                if (!status || row.dataset.status === status) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Filter by sector
        function filterBySector(sector) {
            const rows = document.querySelectorAll('.lead-row');
            rows.forEach(row => {
                if (!sector || row.dataset.sector === sector) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Search
        document.getElementById('search-input').addEventListener('input', function() {
            const query = this.value.toLowerCase();
            const rows = document.querySelectorAll('.lead-row');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(query) ? '' : 'none';
            });
        });

        // Logout
        async function logout() {
            await fetch('/api/admin/logout', { method: 'POST' });
            window.location.href = '/admin/login';
        }
    </script>
</body>
</html>
